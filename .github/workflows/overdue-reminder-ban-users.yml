name: Daily Overdue Reminder - Ban Users

on:
  schedule:
    - cron: '0 9 * * *'  # 9h UTC ~6h BR, muda pra '0 12 * * *' pra ~9h BR
  workflow_dispatch:

permissions:
  issues: write  # Pra postar coment√°rio
  projects: read  # Pra ler o project

jobs:
  reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Remind overdue issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const query = `query {
              organization(login: "mooze-labs") {
                projectV2(number: 5) {
                  items(first: 100) {  # Aumenta se tiver mais issues
                    nodes {
                      id
                      fieldValueByName(name: "Target date") {
                        ... on ProjectV2ItemFieldDateValue {
                          date
                        }
                      }
                      content {
                        ... on Issue {
                          id
                          number
                          assignees(first: 10) {
                            nodes {
                              login
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }`;

            const data = await github.graphql(query);
            const today = new Date().toISOString().split('T')[0];  // Data de hoje YYYY-MM-DD

            for (const item of data.organization.projectV2.items.nodes) {
              const dueDate = item.fieldValueByName?.date;
              if (dueDate && dueDate < today) {
                const issue = item.content;
                if (issue) {
                  const assignees = issue.assignees.nodes.map(a => `@${a.login}`).join(' ');
                  const message = `${assignees} The following issue #${issue.number} has been overdue since ${dueDate}! As an immediate priority of banning these users, the same scammers will continue to cause problems for our payments partner as long as they are not banned.`;
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: message
                  });
                }
              }
            }
